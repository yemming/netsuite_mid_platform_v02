# AI OCR 新格式測試檢查清單

> **測試日期**: 2025-01-XX  
> **測試目標**: 驗證 N8N 新 JSON 格式 `[ { output: {...}, success: true, ... } ]` 在所有場景下正常工作

---

## 📋 測試前準備

### 環境檢查
- [ ] 確認 N8N webhook URL 已正確設定（`NEXT_PUBLIC_N8N_WEBHOOK_OCR`）
- [ ] 確認服務器正在運行（`npm run dev`）
- [ ] 準備測試用的發票圖片或 PDF 檔案
- [ ] 確認 Supabase 連線正常

### 測試資料準備
- [ ] 準備至少 1 張包含完整發票資訊的圖片
- [ ] 確認測試圖片包含以下欄位：
  - 發票標題、發票號碼、開立時間
  - 賣方/買方資訊（名稱、統編、地址）
  - 金額資訊（未稅銷售額、稅額、總計金額）
  - **費用類別**（如 "11"）
  - **費用描述**（如 "NetSuite 訂閱費"）

---

## 🧪 核心功能測試

### 1. 同步響應測試（N8N 立即返回結果）

**測試場景**: N8N 在收到請求後立即返回 OCR 結果（不通過 callback）

**測試步驟**:
1. [ ] 進入費用報告建立頁面 (`/dashboard/ocr-expense`)
2. [ ] 上傳一張發票圖片
3. [ ] 點擊「AI OCR 識別」按鈕
4. [ ] 觀察瀏覽器 Console，確認收到同步響應：
   ```
   [processSingleAttachmentOCR] 附件 X 收到 N8N 同步響應
   ```

**預期結果**:
- [ ] OCR 結果立即顯示，不需要等待
- [ ] Expense line 自動建立
- [ ] 所有發票欄位正確填入（發票號碼、金額等）
- [ ] **費用描述**正確填入 memo 欄位
- [ ] **費用類別**正確匹配到 expense category
- [ ] OCR 元數據正確顯示（confidence, qualityGrade 等）

**檢查點**:
- [ ] 檢查 Console 是否有錯誤訊息
- [ ] 檢查 expense line 的 `memo` 欄位是否包含「費用描述」
- [ ] 檢查 expense line 的 `category` 是否正確匹配

---

### 2. 異步回調測試（N8N 通過 Callback URL 返回）

**測試場景**: N8N 異步處理，通過 callback URL 返回結果

**測試步驟**:
1. [ ] 進入費用報告建立頁面
2. [ ] 上傳一張發票圖片
3. [ ] 點擊「AI OCR 識別」按鈕
4. [ ] 觀察瀏覽器 Console，確認開始輪詢：
   ```
   附件 X 開始輪詢 OCR 結果
   ```
5. [ ] 等待 N8N 處理完成（通常 5-30 秒）
6. [ ] 觀察 Console，確認收到回調結果

**預期結果**:
- [ ] 輪詢機制正常啟動（每 2 秒檢查一次）
- [ ] 收到回調後，expense line 自動建立
- [ ] 所有欄位正確填入
- [ ] **費用描述**正確填入 memo 欄位
- [ ] 輪詢自動停止

**檢查點**:
- [ ] 檢查 `/api/ocr-callback` 是否正確接收 N8N 回調
- [ ] 檢查 Console 是否有輪詢相關的錯誤
- [ ] 檢查結果是否正確保存到內存存儲

---

### 3. 多附件批次處理測試

**測試場景**: 一次上傳多張發票，批次處理 OCR

**測試步驟**:
1. [ ] 進入費用報告建立頁面
2. [ ] 上傳 **2-3 張**不同的發票圖片
3. [ ] 點擊「AI OCR 識別」按鈕
4. [ ] 觀察多附件 OCR 任務狀態

**預期結果**:
- [ ] 每個附件都有獨立的 OCR 任務
- [ ] 任務狀態正確顯示（processing → completed）
- [ ] 每個附件都建立對應的 expense line
- [ ] 每個 expense line 的 memo 都包含對應的「費用描述」
- [ ] 所有任務完成後，狀態自動清空

**檢查點**:
- [ ] 檢查 `multiOcrTasks` 狀態是否正確更新
- [ ] 檢查是否有重複處理的問題
- [ ] 檢查所有 expense lines 是否都有正確的 OCR 資料

---

## 🔍 資料格式驗證

### 4. 新格式欄位完整性測試

**測試場景**: 驗證所有新格式欄位都能正確處理

**測試步驟**:
1. [ ] 執行一次完整的 OCR 識別
2. [ ] 檢查 expense line 的 `ocrData` 物件
3. [ ] 驗證以下欄位是否存在且正確：

**必填欄位檢查**:
- [ ] `ocrSuccess`: 應為 `true` 或 `false`
- [ ] `ocrConfidence`: 應為 0-1 之間的小數（如 0.9 表示 90%）
- [ ] `ocrDocumentType`: 應為 "電子發票" 或其他類型
- [ ] `ocrErrors`: 應為字串（如 "無"）
- [ ] `ocrWarnings`: 應為字串（如 "日期過舊..."）
- [ ] `ocrErrorCount`: 應為數字
- [ ] `ocrWarningCount`: 應為數字
- [ ] `ocrQualityGrade`: 應為 "A", "B", "C" 等
- [ ] `ocrFileName`: 應為檔案名稱
- [ ] `ocrProcessedAt`: 應為 ISO 時間字串

**Output 欄位檢查**:
- [ ] `invoiceTitle`: 發票標題
- [ ] `invoiceNumber`: 發票號碼
- [ ] `invoiceDate`: 開立時間
- [ ] `sellerName`, `sellerTaxId`, `sellerAddress`: 賣方資訊
- [ ] `buyerName`, `buyerTaxId`, `buyerAddress`: 買方資訊
- [ ] `untaxedAmount`, `taxAmount`, `totalAmount`: 金額資訊
- [ ] `費用類別`: 應正確匹配到 expense category
- [ ] `費用描述`: 應填入 memo 欄位

---

### 5. 費用描述欄位測試

**測試場景**: 驗證「費用描述」欄位正確處理

**測試步驟**:
1. [ ] 使用包含「費用描述」的測試資料
2. [ ] 執行 OCR 識別
3. [ ] 檢查 expense line 的 `memo` 欄位

**預期結果**:
- [ ] 如果 OCR 結果有「費用描述」，應優先填入 `memo`
- [ ] 如果沒有「費用描述」，應使用 `formData.description`
- [ ] 如果兩者都沒有，`memo` 應為空字串

**測試案例**:
- [ ] 測試案例 1: OCR 有「費用描述」= "NetSuite 訂閱費"
  - 預期: `memo` = "NetSuite 訂閱費"
- [ ] 測試案例 2: OCR 沒有「費用描述」，但表單有 description
  - 預期: `memo` = `formData.description`
- [ ] 測試案例 3: 兩者都沒有
  - 預期: `memo` = ""

---

### 6. 費用類別匹配測試

**測試場景**: 驗證「費用類別」正確匹配到 expense category

**測試步驟**:
1. [ ] 確認 expense categories 已載入
2. [ ] 使用包含「費用類別」= "11" 的測試資料
3. [ ] 執行 OCR 識別
4. [ ] 檢查 expense line 的 `category` 欄位

**預期結果**:
- [ ] 如果「費用類別」是數字（如 "11"），應透過 `netsuite_internal_id` 匹配
- [ ] 如果匹配成功，`category` 應為對應的 category ID
- [ ] 如果匹配失敗，應在 Console 顯示警告訊息

**測試案例**:
- [ ] 測試案例 1: 「費用類別」= "11"，且存在對應的 category
  - 預期: `category` = 對應的 category ID
- [ ] 測試案例 2: 「費用類別」= "999"，不存在對應的 category
  - 預期: `category` = ""，Console 顯示警告
- [ ] 測試案例 3: 「費用類別」= 名稱（非數字）
  - 預期: 嘗試名稱匹配，如果失敗則 `category` = ""

---

## ⚠️ 邊界情況測試

### 7. 陣列格式處理測試

**測試場景**: 驗證陣列格式的正確處理

**測試步驟**:
1. [ ] 確認 N8N 返回的是陣列格式 `[ { output: {...}, ... } ]`
2. [ ] 檢查程式碼是否正確提取 `result[0]`

**預期結果**:
- [ ] 程式碼能正確識別陣列格式
- [ ] 正確提取第一個元素 `result[0]`
- [ ] 所有欄位從 `result[0].output` 正確讀取

**檢查點**:
- [ ] 檢查 `convertOCRResultToLineData` 函數
- [ ] 檢查 `processOCRResult` 函數
- [ ] 檢查 `createExpenseLineFromOCR` 函數

---

### 8. 向後相容性測試

**測試場景**: 驗證舊格式（物件格式）仍能正常工作

**測試步驟**:
1. [ ] 模擬 N8N 返回舊格式 `{ output: {...}, success: true, ... }`
2. [ ] 執行 OCR 識別

**預期結果**:
- [ ] 程式碼能正確處理舊格式
- [ ] 所有功能正常運作
- [ ] 沒有錯誤訊息

---

### 9. 錯誤處理測試

**測試場景**: 驗證各種錯誤情況的處理

**測試案例**:
- [ ] 測試案例 1: N8N 返回錯誤
  - 預期: 錯誤訊息正確顯示，任務狀態為 `error`
- [ ] 測試案例 2: N8N 返回空陣列 `[]`
  - 預期: 正確處理，不崩潰
- [ ] 測試案例 3: N8N 返回格式錯誤的資料
  - 預期: 錯誤訊息正確顯示
- [ ] 測試案例 4: 輪詢超時（5 分鐘）
  - 預期: 超時後顯示錯誤訊息，停止輪詢

---

## 🔧 技術細節檢查

### 10. Console 日誌檢查

**檢查點**:
- [ ] 確認所有關鍵步驟都有 Console 日誌
- [ ] 確認日誌訊息清楚易懂
- [ ] 確認沒有不必要的錯誤訊息

**關鍵日誌**:
```
[processSingleAttachmentOCR] 附件 X 收到 N8N 同步響應
[handleOCRResult] 附件 X 開始建立 expense line
[createExpenseLineFromOCR] 透過 netsuite_internal_id 匹配到費用類別
[ocr-callback] 保存 OCR 結果
```

---

### 11. 資料庫保存測試

**測試場景**: 驗證 OCR 結果正確保存到資料庫

**測試步驟**:
1. [ ] 執行一次完整的 OCR 識別
2. [ ] 保存費用報告
3. [ ] 檢查資料庫中的 `expense_lines` 表

**預期結果**:
- [ ] `ocr_success` 欄位正確
- [ ] `ocr_confidence` 欄位正確（0-1 之間）
- [ ] `ocr_document_type` 欄位正確
- [ ] `ocr_errors`, `ocr_warnings` 欄位正確
- [ ] `ocr_quality_grade` 欄位正確
- [ ] `memo` 欄位包含「費用描述」（如果有）

---

## 📊 效能測試

### 12. 響應時間測試

**測試場景**: 驗證 OCR 處理的響應時間

**測試步驟**:
1. [ ] 記錄 OCR 開始時間
2. [ ] 記錄 OCR 完成時間
3. [ ] 計算總耗時

**預期結果**:
- [ ] 同步響應: < 5 秒
- [ ] 異步回調: < 30 秒（取決於 N8N 處理時間）
- [ ] 輪詢間隔: 2 秒（符合設定）

---

## ✅ 測試完成檢查清單

### 功能完整性
- [ ] 所有核心功能測試通過
- [ ] 所有邊界情況測試通過
- [ ] 所有錯誤處理測試通過

### 資料正確性
- [ ] 所有欄位正確映射
- [ ] 費用描述正確填入
- [ ] 費用類別正確匹配

### 穩定性
- [ ] 沒有崩潰或錯誤
- [ ] 沒有記憶體洩漏
- [ ] 沒有重複處理問題

### 使用者體驗
- [ ] 載入狀態正確顯示
- [ ] 錯誤訊息清楚易懂
- [ ] 操作流程順暢

---

## 🐛 已知問題記錄

如果測試過程中發現問題，請記錄在此：

1. **問題描述**: 
   - **重現步驟**: 
   - **預期行為**: 
   - **實際行為**: 
   - **嚴重程度**: [高/中/低]
   - **狀態**: [待修復/已修復/不需要修復]

---

## 📝 測試結果總結

**測試日期**: _______________

**測試人員**: _______________

**總測試項目**: ___ / 12

**通過項目**: ___ / 12

**失敗項目**: ___ / 12

**整體評估**: [✅ 通過 / ⚠️ 部分通過 / ❌ 未通過]

**備註**: 
_________________________________________________
_________________________________________________

---

## 🚀 下一步行動

- [ ] 修復所有發現的問題
- [ ] 更新相關文件
- [ ] 通知相關人員測試結果
- [ ] 準備部署到生產環境

